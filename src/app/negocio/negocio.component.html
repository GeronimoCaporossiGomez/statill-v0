<app-header-statill></app-header-statill>

@if (cargando) {
  <div class="loading">
    <p>Cargando...</p>
  </div>
} @else if (comercio) {
  <div class="container">
    <!-- Header del comercio -->
    <div class="store-header">
      <button class="back-button" (click)="volver()">
        <span class="arrow">←</span>
      </button>
      <div class="store-info">
        <h1 class="store-name">{{ comercio.name }}</h1>
        <p class="store-address">{{ comercio.address }}</p>
      </div>
    </div>

    <!-- Barra de búsqueda -->
    <div class="search-bar">
      <input type="text" placeholder="Busque productos aquí">
    </div>

    <!-- Productos -->
    <div class="productos-container">
      <h2 class="seccion-titulo">Productos</h2>
      <div class="productos-grid">
        @for (producto of productos; track producto.id) {
          <div class="producto-card">
            <div class="producto-info">
              <h3 class="producto-nombre">{{ producto.name }}</h3>
              <p class="producto-descripcion">{{ producto.brand }}</p>
              <p class="producto-precio">${{ producto.price }}</p>
              
              <!-- Botones de cantidad -->
              <div class="cantidad-controls">
                @if (getCantidad(producto.id) === 0) {
                  <button class="btn-agregar" (click)="agregarProducto(producto.id)">
                    Agregar al carrito
                  </button>
                } @else {
                  <div class="contador">
                    <button class="btn-menos" (click)="quitarProducto(producto.id)">-</button>
                    <span class="cantidad">{{ getCantidad(producto.id) }}</span>
                    <button class="btn-mas" (click)="agregarProducto(producto.id)">+</button>
                  </div>
                }
              </div>
            </div>
            <div class="producto-imagen">
              @if (producto.image) {
                <img [src]="producto.image" [alt]="producto.name">
              }
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Botón de finalizar compra -->
    @if (getTotalItems() > 0) {
      <div class="carrito-flotante">
        <button class="btn-finalizar" (click)="finalizarCompra()">
          Finalizar Compra ({{ getTotalItems() }} productos)
        </button>
      </div>
    }
  </div>
} @else {
  <div class="error">
    <p>Comercio no encontrado</p>
    <button (click)="volver()">Volver</button>
  </div>
}

<header class="Abajo">
  <div class="Reseña">
    <span class="textoReseña">Reseña</span>
    @if (checkingPurchase) {
      <p class="info-message">Verificando si puedes dejar una reseña...</p>
    } @else if (!hasPurchasedFromStore && authService.isActiveUser()) {
      <p class="warning-message">Solo puedes dejar una reseña después de realizar un pedido en esta tienda.</p>
    }
    <div class="Estrellas">
      <span>Bueno</span>
      <button (click)="setValue(1)" [class.active]="estrellas >= 1" class="Estrella"><img src="assets/img/estrella.png" class="estrellaFoto"></button>
      <button (click)="setValue(2)" [class.active]="estrellas >= 2" class="Estrella"><img src="assets/img/estrella.png" class="estrellaFoto"></button>
      <button (click)="setValue(3)" [class.active]="estrellas >= 3" class="Estrella"><img src="assets/img/estrella.png" class="estrellaFoto"></button>
      <button (click)="setValue(4)" [class.active]="estrellas >= 4" class="Estrella"><img src="assets/img/estrella.png" class="estrellaFoto"></button>
      <button (click)="setValue(5)" [class.active]="estrellas >= 5" class="Estrella"><img src="assets/img/estrella.png" class="estrellaFoto"></button>
      <span>Malo</span>
    </div>
    <input 
      type="text" 
      placeholder="Ingrese su reseña aquí" 
      class="ReseñaTextBox" 
      [(ngModel)]="textValue"
      [disabled]="checkingPurchase || (!hasPurchasedFromStore && authService.isActiveUser())">
    <button 
      (click)="submitReview()"
      [disabled]="checkingPurchase || (!hasPurchasedFromStore && authService.isActiveUser())">
      OK
    </button>
  </div>

  <div class="reseñasGrid">
    <h3>Reseñas</h3>
    @if (reviews && reviews.length > 0) {
      <div class="reseñas-lista">
        @for (review of reviews; track review.id) {
          <div class="reseña-card">
            <div class="reseña-header">
              <div class="reseña-estrellas">
                @for (i of [1,2,3,4,5]; track i) {
                  <span [class.filled]="i <= review.stars">★</span>
                }
              </div>
              <span class="reseña-fecha">Usuario #{{ review.user_id }}</span>
            </div>
            <p class="reseña-texto">{{ review.desc }}</p>
          </div>
        }
      </div>
    } @else {
      <p class="sin-reseñas">No hay reseñas todavía. ¡Sé el primero en dejar una!</p>
    }
  </div>





<app-sidebar></app-sidebar>

<div class="contenedor-principal">
  <!-- Sección de cámara y escáner -->
  <div class="seccion-camara">
    <div class="cuadrado-escanear">
      <h1>📷 Escanear Códigos de Barras</h1>
      <div class="color-box">
        <div class="scanner-info">
          <span class="scanner-icon">📊</span>
          <p>Escanea códigos de barras para buscar productos o crear nuevos</p>
        </div>
      </div>
    </div>

    <div class="scanner-container">
      <h2>Cámara y Escáner</h2>

      <div *ngIf="errorMessage" class="message" 
           [ngClass]="{'success': errorMessage.includes('exitosamente'), 'error': !errorMessage.includes('exitosamente') && !errorMessage.includes('Escaneando')}">
        {{ errorMessage }}
      </div>

      <div class="video-container">
        <div #video id="scanner-container" 
             [class.scanning]="isScanning"></div>
        <div *ngIf="isScanning" class="scanning-overlay">
          <div class="scanning-line"></div>
          <p>Escaneando código de barras...</p>
        </div>
      </div>

      <div class="camera-controls">
        <button (click)="toggleCamera()" class="btn-primary">
          {{ isCameraOn ? '📹 Apagar cámara' : '📷 Encender cámara' }}
        </button>
        <button (click)="startScanning()" [disabled]="!isCameraOn || isScanning" class="btn-scan">
          {{ isScanning ? '⏳ Escaneando...' : '🔍 Escanear código' }}
        </button>
        <button (click)="stopScanning()" [disabled]="!isScanning" class="btn-stop">
          ⏹️ Detener escaneo
        </button>
      </div>
    </div>
  </div>

  <!-- Sección de resultados y formularios -->
  <div class="seccion-formulario">
    
    <!-- Mostrar productos encontrados -->
    <div *ngIf="foundProducts.length > 0 && !showCreateForm" class="productos-encontrados">
      <h2>✅ Productos Encontrados</h2>
      <div class="producto-info">
        <div class="producto-header">
          <h3>{{ displayData.nombre }}</h3>
          <span class="codigo-badge">{{ displayData.codigo }}</span>
        </div>
        <div class="producto-details">
          <p><strong>Marca:</strong> {{ displayData.marca }}</p>
          <p><strong>Precio:</strong> {{ displayData.precio }}</p>
          <p><strong>Categoría:</strong> {{ displayData.tipo }}</p>
          <p><strong>Fecha:</strong> {{ displayData.fecha }}</p>
        </div>
      </div>
      
      <div class="multiple-products" *ngIf="foundProducts.length > 1">
        <p><strong>{{ foundProducts.length - 1 }} producto(s) más con este código</strong></p>
        <button class="btn-secondary">Ver todos</button>
      </div>
    </div>

    <!-- Formulario de crear producto usando ProductoFormComponent -->
    <app-producto-form
      [producto]="producto"
      [isLoading]="isLoading"
      [errorMessage]="errorMessage"
      [showForm]="showCreateForm"
      [title]="foundProducts.length > 0 ? 'Crear Producto (Datos Sugeridos)' : 'Crear Nuevo Producto'"
      [submitButtonText]="'Crear Producto'"
      [showBarcodeField]="true"
      [showStoreIdField]="true"
      [suggestedData]="foundProducts"
      (onSubmit)="onProductoSubmit($event)"
      (onCancel)="onCancelar()"
      (onReset)="onReset()"
      (onUseSuggestedData)="onUseSuggestedData($event)">
    </app-producto-form>

    <!-- Información adicional cuando hay productos encontrados -->
    <div *ngIf="foundProducts.length > 0 && showCreateForm" class="found-products-info">
      <h4>🔍 Información del Escaneo</h4>
      <p><strong>Código escaneado:</strong> {{ scannedBarcode }}</p>
      <p><strong>Tienda:</strong> {{ currentStore?.name || 'No especificada' }}</p>
      <p><strong>Productos similares encontrados:</strong> {{ foundProducts.length }}</p>
    </div>

    <!-- Información básica cuando no hay datos -->
    <div *ngIf="!showCreateForm && foundProducts.length === 0" class="info-inicial">
      <h2>📊 Información del Escaneo</h2>
      <div class="info-placeholder">
        <div class="placeholder-icon">🔍</div>
        <p>Enciende la cámara y escanea un código de barras para comenzar</p>
        <div class="steps">
          <div class="step">1️⃣ Enciende la cámara</div>
          <div class="step">2️⃣ Inicia el escaneo</div>
          <div class="step">3️⃣ Apunta al código de barras</div>
        </div>
      </div>
    </div>

    <!-- Botón de limpiar siempre visible -->
    <div class="acciones-formulario">
      <button (click)="resetForm()" class="btn-clean">
        🧹 Limpiar Todo
      </button>
    </div>
  </div>
</div>
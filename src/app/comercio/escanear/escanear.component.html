<app-sidebar></app-sidebar>

<div class="contenedor-principal">
  <!-- Sección de cámara y escáner -->
  <div class="seccion-camara">
    <div class="scanner-frame">
      <div class="video-container">
        <div #video id="scanner-container" [class.scanning]="isScanning"></div>
        <div *ngIf="!isCameraOn" class="frame-placeholder">
           <img src="assets/img/Escanear-icono.png" alt="Ícono de código de barras" style="width: 220px; height: 156px;">
        </div>
        <div *ngIf="isScanning" class="scanning-overlay">
          <div class="scanning-line"></div>
          <p>Escaneando código de barras...</p>
        </div>
      </div>
    </div>

    <div class="camera-controls">
      <button (click)="toggleCamera()" class="btn-pill btn-red">
        {{ isCameraOn ? "Apagar Cámara" : "Prender Cámara" }}
      </button>
      <button
        (click)="startScanning()"
        [disabled]="!isCameraOn || isScanning"
        class="btn-pill btn-red-outline"
      >
        {{ isScanning ? "Escaneando…" : "Escanear productos" }}
      </button>
      <button
        (click)="stopScanning()"
        [disabled]="!isScanning"
        class="btn-pill btn-gray"
      >
        Detener escaneo
      </button>
    </div>

    <div class="manual-input">
      <input
        type="text"
        class="manual-field"
        maxlength="32"
        placeholder="Ingresar código de barras manualmente"
        [(ngModel)]="manualBarcode"
      />
      <button
        class="btn-pill btn-dark"
        (click)="onManualSubmit()"
        [disabled]="!manualBarcode?.trim()"
      >
        Buscar
      </button>
    </div>

    <div
      *ngIf="errorMessage"
      class="message"
      [ngClass]="{
        success: errorMessage.includes('exitosamente'),
        error:
          !errorMessage.includes('exitosamente') &&
          !errorMessage.includes('Escaneando'),
      }"
    >
      {{ errorMessage }}
    </div>
  </div>

  <!-- Sección de resultados y formularios -->
  <div class="seccion-formulario">
    <!-- Mostrar productos encontrados -->
    <div
      *ngIf="foundProducts.length > 0 && !showCreateForm"
      class="productos-encontrados"
    >
      <h2> Productos Encontrados</h2>
      <div class="producto-info">
        <div class="producto-header">
          <h3>{{ displayData.nombre }}</h3>
          <span class="codigo-badge">{{ displayData.codigo }}</span>
        </div>
        <div class="producto-details">
          <p><strong>Marca:</strong> {{ displayData.marca }}</p>
          <p><strong>Precio:</strong> {{ displayData.precio }}</p>
          <p><strong>Categoría:</strong> {{ displayData.tipo }}</p>
          <p><strong>Fecha:</strong> {{ displayData.fecha }}</p>
        </div>
      </div>

      <div class="multiple-products" *ngIf="foundProducts.length > 1">
        <p>
          <strong
            >{{ foundProducts.length - 1 }} producto(s) más con este
            código</strong
          >
        </p>
        <button class="btn-secondary">Ver todos</button>
      </div>
    </div>

    <!-- Formulario de crear producto usando ProductoFormComponent -->
    <app-producto-form
      [producto]="producto"
      [isLoading]="isLoading"
      [errorMessage]="errorMessage"
      [showForm]="showCreateForm"
      [title]="
        foundProducts.length > 0
          ? 'Crear Producto (Datos Sugeridos)'
          : 'Crear Nuevo Producto'
      "
      [submitButtonText]="'Crear Producto'"
      [showBarcodeField]="true"
      [showStoreIdField]="true"
      [suggestedData]="foundProducts"
      (onSubmit)="onProductoSubmit($event)"
      (onCancel)="onCancelar()"
      (onReset)="onReset()"
      (onUseSuggestedData)="onUseSuggestedData($event)"
    >
    </app-producto-form>

    <!-- Información adicional cuando hay productos encontrados -->
    <div
      *ngIf="foundProducts.length > 0 && showCreateForm"
      class="found-products-info"
    >
      <h4> Información del Escaneo</h4>
      <p><strong>Código escaneado:</strong> {{ scannedBarcode }}</p>
      <p>
        <strong>Tienda:</strong> {{ currentStore?.name || "No especificada" }}
      </p>
      <p>
        <strong>Productos similares encontrados:</strong>
        {{ foundProducts.length }}
      </p>
    </div>

    <!-- Información básica cuando no hay datos -->
    <div
      *ngIf="!showCreateForm && foundProducts.length === 0"
      class="info-inicial"
    >
      <h2> Información del Escaneo</h2>
      <div class="info-placeholder">
        <div class="placeholder-icon"></div>
        <p>Prende la cámara y escanea, o ingresa el código manualmente.</p>
      </div>
    </div>

    <!-- Botón de limpiar siempre visible -->
    <div class="acciones-formulario">
      <button (click)="resetForm()" class="btn-clean">Limpiar Todo</button>
    </div>
  </div>
</div>